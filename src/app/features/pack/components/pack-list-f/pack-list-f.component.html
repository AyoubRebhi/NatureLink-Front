<div class="container">
  <!-- Header -->
  <h2>D√©couvrez nos Packs</h2>
  
  <!-- Loading Indicator -->
  <div *ngIf="loading" class="loading-indicator">
    <div class="spinner"></div>
    <p>Chargement des packs...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage && !loading" class="error-message">
    {{ errorMessage }}
  </div>

  <!-- Pack Grid -->
  <div *ngIf="packs.length > 0 && !loading" class="pack-grid">
    <div *ngFor="let pack of packs" class="pack-card">
      <div class="pack-icon">üéÅ</div>
      <h3>{{ pack.nom }}</h3>
      <p class="price">{{ pack.prix }} TND</p>
      <p class="description">{{ pack.description }}</p>
      
      <div class="rating-display">
        <span *ngFor="let star of getStarRating(pack?.averageRating || 0)" 
              [class.filled]="star === '‚òÖ' || star === '¬Ω'"
              [class.half]="star === '¬Ω'">
          {{ star === '¬Ω' ? '¬Ω' : star }}
        </span>
        <span class="rating-value">({{ pack.averageRating ? pack.averageRating.toFixed(1) : '0' }})</span>
      </div>
      
      <button class="rate-button" (click)="openRatingModal(pack)">Noter ce pack</button>
      <button class="generate-button" (click)="ggenerateImageForPack(pack)">
        üñºÔ∏è G√©n√©rer une image
      </button>
    </div>
  </div>

  <!-- No Packs Message -->
  <div *ngIf="packs.length === 0 && !loading" class="empty-state">
    <p>Aucun pack disponible pour le moment.</p>
  </div>

  <!-- Rating Modal Popup -->
  <div *ngIf="showRatingModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Noter {{ selectedPack?.nom }}</h3>
      </div>
      <div class="modal-body">
        <p>S√©lectionnez votre √©valuation</p>
        
        <div class="star-rating">
          <span *ngFor="let star of [1,2,3,4,5]; let i = index" 
                (click)="selectRating(i + 1)" 
                [class.active]="i < selectedRating">
            ‚òÖ
          </span>
        </div>
        
        <div class="rating-description">
          {{ selectedRating === 0 ? 'S√©lectionnez une note' : 
            selectedRating === 1 ? 'Pas satisfait' :
            selectedRating === 5 ? 'Excellent !' : 
            selectedRating + ' √©toiles' }}
        </div>
        
        <div *ngIf="errorMessage" class="error-message">
          {{ errorMessage }}
        </div>
      </div>
      <div class="modal-footer">
        <button class="cancel-button" (click)="closeRatingModal()">Annuler</button>
        <button class="submit-button" 
                (click)="submitRating()" 
                [disabled]="selectedRating === 0">
          Soumettre
        </button>
      </div>
    </div>
  </div>

  <!-- AI Image Generation Popup -->
  <div *ngIf="showImagePopup" class="image-popup-overlay">
    <div class="image-popup-content">
      <div class="image-popup-header">
        <h3>{{ selectedImagePack?.nom }}</h3>
        <button class="close-button" (click)="closeImagePopup()">√ó</button>
      </div>
      <div class="image-popup-body">
        <p class="image-popup-price">{{ selectedImagePack?.prix }} TND</p>
        <p class="image-popup-description">{{ selectedImagePack?.description }}</p>
        
        <div *ngIf="!generatedImageUrl" class="image-loading">
          <div class="loading-spinner"></div>
          <p>G√©n√©ration de l'image en cours...</p>
        </div>

        <!-- ‚úÖ Image Refresh Fix -->
        <div *ngIf="generatedImageUrl" style="text-align: center;">
          <img 
          *ngIf="generatedImageUrl" 
          [src]="generatedImageUrl" 
          alt="Image g√©n√©r√©e par IA" 
          class="generated-image"
        />
        
        </div>
      </div>
    </div>
  </div>

  <!-- Chatbot Interface -->
  <div class="chatbot-container" [class.active]="showChat">
    <div class="chatbot-header" (click)="toggleChat()">
      <div class="chatbot-title">
        <span class="chatbot-icon">üí¨</span>
        <h3>NatureLink Assistant</h3>
      </div>
      <span class="toggle-icon">{{ showChat ? '‚ñº' : '‚ñ≤' }}</span>
    </div>
    
    <div class="chatbot-body" *ngIf="showChat">
      <div class="chatbot-messages">
        <div *ngFor="let message of chatbotMessages" 
             class="message" 
             [class.user]="message.role === 'user'" 
             [class.bot]="message.role === 'bot'">
          <div class="message-content">
            {{ message.text }}
          </div>
        </div>
      </div>
      
      <div class="chatbot-input">
        <input 
          type="text" 
          [(ngModel)]="userMessage" 
          (keyup.enter)="sendMessage()" 
          placeholder="Posez votre question..."
          class="message-input"
        >
        <button (click)="sendMessage()" class="send-button">
          <svg viewBox="0 0 24 24" width="20" height="20">
            <path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Floating Chat Button -->
  <button class="chatbot-toggle-button" (click)="toggleChat()">
    <span class="chat-icon">üí¨</span>
    <span class="tooltip">Besoin d'aide ?</span>
  </button>
</div>
